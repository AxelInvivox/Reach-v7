<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculateur de Reach - Invivox</title>
  <style>
    /* ‚Äî‚Äî Invivox Theme ‚Äì Ocean Line ‚Äî‚Äî */
    :root{
      --ocean-50:#e7f9fb; /* background */
      --ocean-100:#b5ecf2;
      --ocean-200:#92e2eb;
      --ocean-300:#41cddd;
      --ocean-400:#11c1d4;
      --ocean-500:#0fb0c1; /* accent / CTA */
      --ocean-600:#1f92ac;
      --ocean-700:#0c8997;
      --ocean-800:#096a75;
      --ocean-900:#075159; /* strong text */
    }

    * { box-sizing: border-box; }
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--ocean-50);
      color: var(--ocean-900);
      line-height: 1.55;
    }
    header{
      background: linear-gradient(90deg, var(--ocean-500), var(--ocean-300));
      color:#fff; padding:16px;
    }
    .header-inner{
      max-width: 1080px; margin:0 auto; display:flex; align-items:center; justify-content:space-between;
    }
    header h1{ margin:0; font-size:22px; font-weight:700; }
    header p{ margin:2px 0 0; opacity:.95; font-size:14px; }

    .lang-switch{
      display:flex; gap:6px; background:rgba(255,255,255,.2); padding:4px; border-radius:999px;
    }
    .lang-switch button{
      border:none; cursor:pointer; padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px;
      background:transparent; color:#fff;
    }
    .lang-switch button.active{ background:#fff; color:var(--ocean-500); }

    main{ display:flex; justify-content:center; padding:36px 16px; }
    .card{
      width:100%; max-width:820px; background:#fff; border-radius:16px; padding:24px; 
      box-shadow: 0 10px 25px rgba(7,81,89,.07);
    }
    .card h2{ margin:0 0 18px; font-size:22px; }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .grid-full{ grid-column:1 / -1; }

    label{ font-weight:600; font-size:14px; margin-bottom:6px; display:block; }
    select, input[type="text"], input[type="email"]{
      width:100%; padding:12px 12px; border:1px solid #d8e6ea; border-radius:10px; font-size:16px; background:#fff;
    }

    .helper{ font-size:12px; color:#4b7e86; margin-top:4px; }

    .actions{ display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap: wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius:10px; padding:12px 18px; font-weight:700; font-size:16px;
      background: var(--ocean-500); color:#fff; box-shadow: 0 6px 14px rgba(15,176,193,.25);
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; }
    .btn.secondary{ background:#fff; color:var(--ocean-500); border:1px solid var(--ocean-500); }

    .consent{ display:flex; align-items:flex-start; gap:10px; font-size:14px; }
    .consent input{ margin-top:3px; }

    .toast{ margin-top:8px; font-size:14px; color: var(--ocean-800); display:none; }

    footer{ text-align:center; padding:20px; color: var(--ocean-900); background: var(--ocean-100); }

    /* ‚Äî‚Äî Modal ‚Äî‚Äî */
    dialog.modal{
      border:0; padding:0; border-radius:16px; width:min(92vw, 740px); max-width:740px; 
      box-shadow: 0 24px 60px rgba(7,81,89,.25);
      overflow:hidden;
      animation: modalIn .18s ease-out;
    }
    @keyframes modalIn{ from{ transform: translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    dialog.modal::backdrop{
      background: rgba(7,81,89,.28);
      backdrop-filter: blur(2px);
    }
    .modal-header{
      padding:14px 16px; color:#fff;
      background: linear-gradient(90deg, var(--ocean-500), var(--ocean-300));
      display:flex; align-items:center; justify-content:space-between;
    }
    .modal-title{ margin:0; font-size:18px; font-weight:700; }
    .modal-close{
      border:0; background:rgba(255,255,255,.18); color:#fff; width:34px; height:34px; 
      border-radius:10px; cursor:pointer; font-size:18px; line-height:1;
    }
    .modal-body{ padding:16px; background:#fff; }

    /* Summary (pills + stat) */
    .summary{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background: var(--ocean-100); color: var(--ocean-700);
      border:1px solid #d8e6ea; border-radius:999px; padding:6px 10px; font-weight:600; font-size:13px;
    }
    .stat{ margin-left:auto; text-align:right; }
    .stat-label{ font-size:12px; color:#4b7e86; margin:0; }
    .stat-number{ margin:0; font-size:30px; font-weight:800; color: var(--ocean-900); line-height:1.15; }

    /* CTA zone */
    .cta{
      display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      margin:14px 0 8px;
    }

    /* CTA text (2 phrases) */
    .cta-text{
      margin:8px 0 6px; color: var(--ocean-900);
    }
    .cta-text p{ margin:0 0 6px; }

    /* Status line */
    .status{ font-size:12px; margin-top:10px; }
    .status.ok{ color:#0a7f4b; }     /* subtle green */
    .status.warn{ color:#8a5a00; }   /* subtle amber */

    @media (max-width:640px){
      header h1{ font-size:18px; }
      header p{ font-size:13px; }
      .grid{ grid-template-columns:1fr; }
      .stat{ width:100%; text-align:left; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1 id="title">Calculateur de Reach PDS</h1>
        <p id="subtitle">Estimez le nombre de professionnels de sant√© atteignables avec Invivox</p>
      </div>
      <div class="lang-switch" role="group" aria-label="Language">
        <button type="button" class="lang-btn active" data-lang="fr">FR</button>
        <button type="button" class="lang-btn" data-lang="en">EN</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title">Votre simulation</h2>

      <form id="reachForm" novalidate>
        <div class="grid">
          <div>
            <label for="region" id="label-region">R√©gion</label>
            <select id="region" name="region" required>
              <option value="" id="opt-region-placeholder">‚Äî S√©lectionner ‚Äî</option>
              <option value="France" id="opt-region-fr">France</option>
              <option value="Europe" id="opt-region-eu">Europe</option>
              <option value="US" id="opt-region-us">US</option>
            </select>
          </div>

          <div>
            <label for="specialite" id="label-specialite">Sp√©cialit√©</label>
            <select id="specialite" name="specialite" required>
              <option value="" id="opt-spec-placeholder">‚Äî S√©lectionner ‚Äî</option>
              <option value="MG" id="opt-spec-mg">M√©decin G√©n√©raliste</option>
              <option value="Infirmier" id="opt-spec-infirmier">Infirmier</option>
              <option value="Dermatologues" id="opt-spec-derm">Dermatologue</option>
              <option value="Pharmaciens" id="opt-spec-pharma">Pharmacien</option>
            </select>
          </div>

          <div>
            <label for="societe" id="label-societe">Soci√©t√©</label>
            <input id="societe" name="societe" type="text" required placeholder="Ex. Invivox" />
          </div>
          <div>
            <label for="poste" id="label-poste">Poste</label>
            <input id="poste" name="poste" type="text" required placeholder="Ex. Responsable marketing" />
          </div>
          <div class="grid-full">
            <label for="email" id="label-email">Email professionnel</label>
            <input id="email" name="email" type="email" required placeholder="prenom.nom@entreprise.com" />
            <div class="helper" id="emailHelp"></div>
          </div>

          <div class="grid-full consent">
            <input id="consent" name="consent" type="checkbox" required />
            <label for="consent" id="label-consent">
              J'accepte que mes informations soient utilis√©es pour me transmettre le r√©sultat de la simulation. (RGPD)
            </label>
          </div>
        </div>

        <div class="actions">
          <button id="downloadBtn" class="btn" type="submit" disabled>Obtenir mon reach</button>
          <a id="demoBtn" class="btn secondary" href="https://calendly.com/adevige-invivox/30min" target="_blank" rel="noopener noreferrer">Demander une d√©mo</a>
        </div>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer id="footer-text">¬© 2025 Invivox. Tous droits r√©serv√©s.</footer>

  <!-- ‚Äî‚Äî Modal (Variante A + r√©sum√© + CTA) ‚Äî‚Äî -->
  <dialog id="resultModal" class="modal" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-header">
      <h3 id="modal-title" class="modal-title">Votre r√©sultat</h3>
      <button type="button" id="modalClose" class="modal-close" aria-label="Fermer">√ó</button>
    </div>
    <div class="modal-body">
      <div class="summary">
        <div class="pills">
          <span class="pill" id="pillRegion">üåç <span id="pillRegionLabel">R√©gion</span>: <strong id="pillRegionValue">‚Äî</strong></span>
          <span class="pill" id="pillSpec">üéØ <span id="pillSpecLabel">Sp√©cialit√©</span>: <strong id="pillSpecValue">‚Äî</strong></span>
        </div>
        <div class="stat">
          <p class="stat-label" id="statLabel">Reach estim√©</p>
          <p class="stat-number" id="statNumber">‚Äî</p>
        </div>
      </div>

      <div class="cta">
        <a id="modalDemoBtn" class="btn" href="https://calendly.com/adevige-invivox/30min" target="_blank" rel="noopener noreferrer">Demander une d√©mo</a>
      </div>

      <div class="cta-text">
        <p id="modalCta1">Vous avez l‚Äôaudience. Nous avons la m√©thode pour l‚Äôactiver.</p>
        <p id="modalCta2">Passez du reach aux r√©sultats : en 30 minutes, co-construisons un plan d‚Äôactivation (canaux, pression m√©dia, calendrier) pour convertir cette audience.</p>
      </div>

      <div id="modalStatus" class="status ok"></div>
    </div>
  </dialog>

  <script>
    // ‚Äî‚Äî CONFIG ‚Äî‚Äî
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS6-DukqRR4lAJhiIg2fR5FpNJ2tWEDEjmScu5h6VI5SPAmaKy4npO-1l-bOFtiOwvPg/exec';

    // ‚Äî‚Äî Data ‚Äî‚Äî
    const data = {
      France: { MG: 37000, Infirmier: 300000, Dermatologues: 1600, Pharmaciens: 42000 },
      Europe: { MG: 120000, Infirmier: 700000, Dermatologues: 6600, Pharmaciens: 80000 },
      US: { MG: 24000, Infirmier: 400000, Dermatologues: 2600, Pharmaciens: 51000 }
    };

    // ‚Äî‚Äî I18N ‚Äî‚Äî (CTA = 2 phrases)
    const i18n = {
      fr: {
        docTitle: 'Calculateur de Reach - Invivox',
        headerTitle: 'Calculateur de Reach PDS',
        headerSubtitle: 'Estimez le nombre de professionnels de sant√© atteignables avec Invivox',
        formTitle: 'Votre simulation',
        labels: {
          region: 'R√©gion',
          specialite: 'Sp√©cialit√©',
          societe: 'Soci√©t√©',
          poste: 'Poste',
          email: 'Email professionnel',
          consent: "J'accepte que mes informations soient utilis√©es pour me transmettre le r√©sultat de la simulation. (RGPD)"
        },
        placeholders: {
          region: '‚Äî S√©lectionner ‚Äî',
          specialite: '‚Äî S√©lectionner ‚Äî',
          societe: 'Ex. Invivox',
          poste: 'Ex. Responsable marketing',
          email: 'prenom.nom@entreprise.com'
        },
        regions: { France:'France', Europe:'Europe', US:'US' },
        specs: {
          MG: 'M√©decin G√©n√©raliste',
          Infirmier: 'Infirmier',
          Dermatologues: 'Dermatologue',
          Pharmaciens: 'Pharmacien'
        },
        buttons: { download:'Obtenir mon reach', demo:'Demander une d√©mo' },
        footer: '¬© 2025 Invivox. Tous droits r√©serv√©s.',
        toasts: {
          selectMissing: 'Veuillez s√©lectionner la r√©gion et la sp√©cialit√©.',
          resultReady: 'R√©sultat affich√©.',
          leadNotConfirmed: 'Note: envoi vers Google Sheets non confirm√©.',
          emailRejected: 'Adresse email refus√©e.'
        },
        emailValidation: {
          invalid: "Format d'email invalide",
          example: "Exemple : prenom.nom@entreprise.com",
          blocked: 'Merci d‚Äôutiliser une adresse professionnelle (domaine perso bloqu√©).',
          blockedDomain: (d)=> `Le domaine "${d}" est bloqu√©.`
        },
        modal: {
          title: 'Votre r√©sultat',
          closeLabel: 'Fermer',
          region: 'R√©gion',
          spec: 'Sp√©cialit√©',
          reachLabel: 'Reach estim√©',
          saved: 'Enregistr√© dans Google Sheets',
          notSaved: 'Note : envoi vers Google Sheets non confirm√©.',
          cta1: "Vous avez l‚Äôaudience. Nous avons la m√©thode pour l‚Äôactiver.",
          cta2: "Passez du reach aux r√©sultats : en 30 minutes, co-construisons un plan d‚Äôactivation (canaux, pression m√©dia, calendrier) pour convertir cette audience."
        }
      },
      en: {
        docTitle: 'HCP Reach Calculator - Invivox',
        headerTitle: 'HCP Reach Calculator',
        headerSubtitle: 'Estimate how many healthcare professionals you can reach with Invivox',
        formTitle: 'Your simulation',
        labels: {
          region: 'Region',
          specialite: 'Specialty',
          societe: 'Company',
          poste: 'Job title',
          email: 'Work email',
          consent: 'I agree that my information will be used to send me the simulation result. (GDPR)'
        },
        placeholders: {
          region: '‚Äî Select ‚Äî',
          specialite: '‚Äî Select ‚Äî',
          societe: 'e.g., Invivox',
          poste: 'e.g., Marketing Manager',
          email: 'firstname.lastname@company.com'
        },
        regions: { France:'France', Europe:'Europe', US:'US' },
        specs: {
          MG: 'General Practitioner',
          Infirmier: 'Nurse',
          Dermatologues: 'Dermatologist',
          Pharmaciens: 'Pharmacist'
        },
        buttons: { download:'Get my reach', demo:'Request a demo' },
        footer: '¬© 2025 Invivox. All rights reserved.',
        toasts: {
          selectMissing: 'Please select a region and a specialty.',
          resultReady: 'Result displayed.',
          leadNotConfirmed: 'Note: lead not confirmed saved to Google Sheets.',
          emailRejected: 'Email address rejected.'
        },
        emailValidation: {
          invalid: 'Invalid email format',
          example: 'Example: firstname.lastname@company.com',
          blocked: 'Please use a professional email address (personal domains are blocked).',
          blockedDomain: (d)=> `The domain "${d}" is blocked.`
        },
        modal: {
          title: 'Your result',
          closeLabel: 'Close',
          region: 'Region',
          spec: 'Specialty',
          reachLabel: 'Estimated reach',
          saved: 'Saved to Google Sheets',
          notSaved: 'Note: lead save not confirmed.',
          cta1: "You have the audience. We have the playbook to activate it.",
          cta2: "Turn reach into results: in 30 minutes, let's co-build an activation plan (channels, media pressure, timeline) to convert this audience."
        }
      }
    };
    let lang = 'fr';
    const t = (k)=> k.split('.').reduce((o, i)=> o && o[i], i18n[lang]);

    // ‚Äî‚Äî Selectors ‚Äî‚Äî
    const form = document.getElementById('reachForm');
    const regionEl = document.getElementById('region');
    const specEl = document.getElementById('specialite');
    const emailEl = document.getElementById('email');
    const emailHelp = document.getElementById('emailHelp');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    const consentEl = document.getElementById('consent');

    // Labels / text nodes
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const formTitleEl = document.getElementById('form-title');
    const labelRegionEl = document.getElementById('label-region');
    const labelSpecEl = document.getElementById('label-specialite');
    const labelSocieteEl = document.getElementById('label-societe');
    const labelPosteEl = document.getElementById('label-poste');
    const labelEmailEl = document.getElementById('label-email');
    const labelConsentEl = document.getElementById('label-consent');
    const demoBtn = document.getElementById('demoBtn');
    const footerText = document.getElementById('footer-text');

    // Modal
    const modal = document.getElementById('resultModal');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modalClose');
    const pillRegionLabel = document.getElementById('pillRegionLabel');
    const pillRegionValue = document.getElementById('pillRegionValue');
    const pillSpecLabel = document.getElementById('pillSpecLabel');
    const pillSpecValue = document.getElementById('pillSpecValue');
    const statLabel = document.getElementById('statLabel');
    const statNumber = document.getElementById('statNumber');
    const modalDemoBtn = document.getElementById('modalDemoBtn');
    const modalCta1 = document.getElementById('modalCta1');
    const modalCta2 = document.getElementById('modalCta2');
    const modalStatus = document.getElementById('modalStatus');

    // Options text
    const optRegionPlaceholder = document.getElementById('opt-region-placeholder');
    const optRegionFr = document.getElementById('opt-region-fr');
    const optRegionEu = document.getElementById('opt-region-eu');
    const optRegionUs = document.getElementById('opt-region-us');

    const optSpecPlaceholder = document.getElementById('opt-spec-placeholder');
    const optSpecMg = document.getElementById('opt-spec-mg');
    const optSpecInf = document.getElementById('opt-spec-infirmier');
    const optSpecDerm = document.getElementById('opt-spec-derm');
    const optSpecPharma = document.getElementById('opt-spec-pharma');

    // ‚Äî‚Äî Email rules ‚Äî‚Äî
    const blockedDomains = [
      'gmail.com','googlemail.com','aol.com','icloud.com','me.com','mac.com','msn.com',
      'hotmail.com','outlook.com','live.com','gmx.com','protonmail.com','proton.me','pm.me',
      'wanadoo.fr','wanadoo.com','orange.fr','sfr.fr','free.fr','laposte.net','bbox.fr','numericable.fr','neuf.fr','voila.fr','aliceadsl.fr','tiscali.fr','libertysurf.fr','caramail.com',
      'gmx.fr',
      'yahoo.com','yahoo.fr','yahoo.co.uk','yahoo.es','yahoo.it','yahoo.de',
      'hotmail.fr','hotmail.co.uk','outlook.fr','outlook.es','outlook.it','live.fr'
    ];

    // ‚Äî‚Äî Language switch ‚Äî‚Äî 
    function applyLang(){
      document.documentElement.lang = lang;
      document.title = t('docTitle');

      titleEl.textContent = t('headerTitle');
      subtitleEl.textContent = t('headerSubtitle');
      formTitleEl.textContent = t('formTitle');

      labelRegionEl.textContent = t('labels.region');
      labelSpecEl.textContent = t('labels.specialite');
      labelSocieteEl.textContent = t('labels.societe');
      labelPosteEl.textContent = t('labels.poste');
      labelEmailEl.textContent = t('labels.email');
      labelConsentEl.textContent = t('labels.consent');

      // Placeholders
      regionEl.options[0].textContent = t('placeholders.region');
      specEl.options[0].textContent = t('placeholders.specialite');
      document.getElementById('societe').placeholder = t('placeholders.societe');
      document.getElementById('poste').placeholder = t('placeholders.poste');
      emailEl.placeholder = t('placeholders.email');

      // Region & spec labels
      optRegionFr.textContent = t('regions.France');
      optRegionEu.textContent = t('regions.Europe');
      optRegionUs.textContent = t('regions.US');

      optSpecMg.textContent = t('specs.MG');
      optSpecInf.textContent = t('specs.Infirmier');
      optSpecDerm.textContent = t('specs.Dermatologues');
      optSpecPharma.textContent = t('specs.Pharmaciens');

      // Buttons & footer
      downloadBtn.textContent = t('buttons.download');
      demoBtn.textContent = t('buttons.demo');
      footerText.textContent = t('footer');

      // Modal labels + CTA
      modalTitle.textContent = t('modal.title');
      modalClose.setAttribute('aria-label', t('modal.closeLabel'));
      pillRegionLabel.textContent = t('modal.region');
      pillSpecLabel.textContent = t('modal.spec');
      statLabel.textContent = t('modal.reachLabel');
      modalDemoBtn.textContent = t('buttons.demo');
      modalCta1.textContent = t('modal.cta1');
      modalCta2.textContent = t('modal.cta2');
    }

    // Lang buttons
    const langBtns = document.querySelectorAll('.lang-btn');
    langBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        langBtns.forEach(b=> b.classList.remove('active'));
        btn.classList.add('active');
        lang = btn.dataset.lang;
        applyLang();
        checkValidity();
      });
    });

    // ‚Äî‚Äî Helpers ‚Äî‚Äî 
    const pad = n => String(n).padStart(2,'0');
    function currentTimestamp(){
      const d = new Date();
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;
    }

    function getDomain(email){
      const at = email.lastIndexOf('@');
      return at > -1 ? email.slice(at+1).toLowerCase() : '';
    }
    function isValidEmailFormat(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
    }
    function validateEmailField(){
      emailEl.setCustomValidity('');
      emailHelp.textContent = '';
      const email = emailEl.value.trim();
      if(!email) return;
      if(!isValidEmailFormat(email)){
        emailEl.setCustomValidity(t('emailValidation.invalid'));
        emailHelp.textContent = t('emailValidation.example');
        return;
      }
      const domain = getDomain(email);
      if(blockedDomains.includes(domain)){
        emailEl.setCustomValidity(t('emailValidation.blocked'));
        emailHelp.textContent = t('emailValidation.blockedDomain')(domain);
      }
    }

    function compute(){
      const region = regionEl.value;
      const regionLabel = regionEl.options[regionEl.selectedIndex]?.textContent || region;
      const specialite = specEl.value; // data key
      const specialiteLabel = specEl.options[specEl.selectedIndex]?.textContent || specialite;
      if(!region || !specialite) return null;
      const baseReach = data[region][specialite];
      return { region, regionLabel, specialite, specialiteLabel, baseReach };
    }

    // ‚Äî‚Äî Modal controls ‚Äî‚Äî 
    function openModal(values, savedOk){
      // Fill summary
      pillRegionValue.textContent = values.regionLabel;
      pillSpecValue.textContent = values.specialiteLabel;
      statNumber.textContent = (lang==='fr' ? values.baseReach.toLocaleString('fr-FR') : values.baseReach.toLocaleString('en-US'));

      // Status
      if(savedOk){
        modalStatus.className = 'status ok';
        modalStatus.textContent = t('modal.saved');
      }else{
        modalStatus.className = 'status warn';
        modalStatus.textContent = t('modal.notSaved');
      }

      // Open
      if(typeof modal.showModal === 'function'){ modal.showModal(); }
      else { modal.setAttribute('open',''); } // fallback
    }
    function closeModal(){
      if(typeof modal.close === 'function'){ modal.close(); }
      else { modal.removeAttribute('open'); }
    }
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('cancel', (e)=>{ e.preventDefault(); closeModal(); }); // Esc
    modal.addEventListener('click', (e)=>{
      const rect = modal.getBoundingClientRect();
      const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
      if(!inDialog) closeModal();
    });

    function setToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 4000); }
    function checkValidity(){ validateEmailField(); downloadBtn.disabled = !form.checkValidity() || !compute(); }

    async function saveLead(values){
      const params = new URLSearchParams();
      params.append('timestamp', new Date().toISOString());
      params.append('societe', document.getElementById('societe').value.trim());
      params.append('poste', document.getElementById('poste').value.trim());
      params.append('email', emailEl.value.trim());
      params.append('region', values.region);
      params.append('specialite', values.specialite);
      params.append('reach_total', String(values.baseReach));
      params.append('userAgent', navigator.userAgent);
      params.append('referrer', document.referrer);

      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });

      let data;
      try { data = await res.json(); } catch(e){ data = { result:'ok' }; }
      return data;
    }

    // ‚Äî‚Äî Events ‚Äî‚Äî
    form.addEventListener('input', checkValidity);
    emailEl.addEventListener('input', checkValidity);
    regionEl.addEventListener('change', checkValidity);
    specEl.addEventListener('change', checkValidity);
    consentEl.addEventListener('change', checkValidity);

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      validateEmailField();
      if(!form.checkValidity()) { form.reportValidity(); return; }
      const values = compute();
      if(!values){ setToast(t('toasts.selectMissing')); return; }

      downloadBtn.disabled = true;

      let savedOk = true;
      try{
        const result = await saveLead(values);
        if(result && result.result === 'error'){
          setToast(result.message || t('toasts.emailRejected'));
          downloadBtn.disabled = false;
          return;
        }
      }catch(err){
        console.warn('Lead save error:', err);
        savedOk = false;
        setToast(t('toasts.leadNotConfirmed'));
      }

      openModal(values, savedOk);
      setToast(t('toasts.resultReady'));

      form.reset();
      checkValidity();
    });

    // init (default FR)
    applyLang();
    checkValidity();
  </script>
</body>
</html>
